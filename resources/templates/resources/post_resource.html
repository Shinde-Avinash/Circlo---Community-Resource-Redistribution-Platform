{% extends 'base.html' %}

{% block title %}Post Resource{% endblock %}

{% block extra_head %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        #location-map { height: 400px; width: 100%; border-radius: 6px; border: 1px solid var(--border-color); }
    </style>
{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; max-width: 1200px; margin: 2rem auto;">
    
    <!-- Left Column: User History -->
    <div style="display: flex; flex-direction: column; gap: 2rem;">
        
        <!-- Posted Items -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--primary-color);">üì¶ My Posted Items</h3>
            {% if posted_resources %}
                <div style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem;">
                    {% for res in posted_resources %}
                        <div style="padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 6px; display: flex; justify-content: space-between; align-items: center; background: var(--bg-color);">
                            <div>
                                <div style="font-weight: 600;">{{ res.title }}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">
                                    {{ res.date_posted|date:"M d" }} ‚Ä¢ <span class="badge badge-{{ res.urgency }}" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">{{ res.urgency|title }}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <a href="{% url 'update_resource' res.id %}" class="btn" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #3B82F6; color: white;">Edit</a>
                                <a href="{% url 'resource_detail' res.id %}" class="btn" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; border: 1px solid var(--border-color);">View</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p style="color: var(--text-muted); font-style: italic;">You haven't posted any items yet.</p>
            {% endif %}
        </div>

        <!-- Claimed Items -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--accent-color);">üôå My Claimed Items</h3>
            {% if my_claims %}
                <div style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem;">
                    {% for claim in my_claims %}
                        <!-- We use claim.resource to access the resource details -->
                        <div style="padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 6px; display: flex; justify-content: space-between; align-items: center; background: var(--bg-color);">
                            <div>
                                <div style="font-weight: 600;">{{ claim.resource.title }}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">
                                    Claimed: {{ claim.quantity }} {{ claim.resource.unit }}<br>
                                    from {{ claim.resource.donor.username }}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <a href="{% url 'resource_detail' claim.resource.id %}" class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">View</a>
                                <form action="{% url 'unclaim_resource' claim.resource.id %}" method="post" onsubmit="return openUnclaimModal(event, this);">
                                    {% csrf_token %}
                                    <button type="submit" class="btn" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: var(--danger); color: white; border: none;">Unclaim</button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p style="color: var(--text-muted); font-style: italic;">You haven't claimed any items yet.</p>
            {% endif %}
        </div>

    </div>

    <!-- Right Column: Post Form -->
    <div class="card" style="height: fit-content;">
        <h2 style="border-bottom: 2px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem;">{{ title|default:"Post a New Resource" }}</h2>
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            {% for field in form %}
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}
                    <small style="color: var(--text-muted); display: block;">{{ field.help_text }}</small>
                {% endif %}
                {% if field.errors %}
                    <div style="color: var(--status-red);">{{ field.errors }}</div>
                {% endif %}
            </div>
            {% endfor %}

            <div style="margin-bottom: 1.5rem;">
                <button type="button" class="btn" style="background: #e0e0e0; color: #333;" onclick="getLocation()">üìç Auto-detect My Location</button>
                <button type="button" class="btn" style="background: #e0e0e0; color: #333; margin-left: 0.5rem;" onclick="openMapModal()">üó∫Ô∏è Select on Map</button>
                <span id="loc-status" style="margin-left: 1rem; font-size: 0.9rem; color: var(--text-muted);"></span>
            </div>

            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">Save Resource</button>
                {% if form.instance.pk %}
                    <button type="button" class="btn" style="background: var(--danger); color: white; border: none; flex: 1;" onclick="openDeleteModal()">Delete Resource</button>
                {% endif %}
                <button type="button" class="btn" style="background: #e0e0e0; color: #333; border: none; flex: 1;" onclick="window.history.back()">Cancel</button>
            </div>
            
            {% if form.instance.pk %}
                <!-- Hidden delete form -->
                <input type="hidden" id="delete-flag" name="delete" value="false">
            {% endif %}
        </form>
    </div>
</div>

<style>
    /* Responsive adjustment for mobile */
    @media (max-width: 768px) {
        div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
        }
    }
    input[type="text"], input[type="number"], textarea, select, input[type="file"] {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-sizing: border-box;
        background: var(--bg-color);
        color: var(--text-color);
    }
</style>

<script>
    function getLocation() {
        const status = document.getElementById('loc-status');
        if (!navigator.geolocation) {
            status.textContent = "Geolocation is not supported by your browser";
        } else {
            status.textContent = "Locating...";
            navigator.geolocation.getCurrentPosition(success, error);
        }
    }

    function success(position) {
        const latitude  = position.coords.latitude;
        const longitude = position.coords.longitude;
        document.getElementById('loc-status').textContent = "Location found!";
        
        // Assuming form fields are named 'latitude' and 'longitude'
        document.querySelector('input[name="latitude"]').value = latitude;
        document.querySelector('input[name="longitude"]').value = longitude;
    }

    function error() {
        document.getElementById('loc-status').textContent = "Unable to retrieve your location";
    }
</script>

<!-- Custom Unclaim Modal -->
<div id="unclaimModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; match-parent; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-color); padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
        <h3 style="margin-bottom: 1rem; color: var(--danger);">Confirm Unclaim</h3>
        <p style="margin-bottom: 1.5rem; color: var(--text-color);">Are you sure you want to unclaim this item? It will become available for others to claim.</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button class="btn" style="background: #e0e0e0; border: none; color: #333;" onclick="closeUnclaimModal()">Cancel</button>
            <button id="confirmUnclaimBtn" class="btn" style="background: var(--danger); color: white; border: none;">Yes, Unclaim it</button>
        </div>
    </div>
</div>

<!-- Custom Delete Modal -->
{% if form.instance.pk %}
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-color); padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
        <h3 style="margin-bottom: 1rem; color: var(--danger);">Delete Resource</h3>
        <p style="margin-bottom: 1.5rem; color: var(--text-color);">Are you sure you want to delete <strong>{{ form.instance.title }}</strong>? This action cannot be undone.</p>
        
        <!-- Separate Form for Deletion -->
        <form action="{% url 'delete_resource' form.instance.id %}" method="post">
            {% csrf_token %}
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button type="button" class="btn" style="background: #e0e0e0; border: none; color: #333;" onclick="closeDeleteModal()">Cancel</button>
                <button type="submit" class="btn" style="background: var(--danger); color: white; border: none;">Yes, Delete it</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- Map Selection Modal -->
<div id="mapModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-color); padding: 1.5rem; border-radius: 12px; max-width: 600px; width: 95%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 1px solid var(--border-color);">
        <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Select Location</h3>
        <p style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">Drag the marker to the correct position.</p>
        
        <div id="location-map"></div>
        
        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
            <button class="btn" style="background: #e0e0e0; border: none; color: #333;" onclick="closeMapModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmLocation()">Confirm Location</button>
        </div>
    </div>
</div>

<script>
    let currentUnclaimForm = null;

    function openUnclaimModal(event, form) {
        event.preventDefault();
        currentUnclaimForm = form;
        document.getElementById('unclaimModal').style.display = 'flex';
        return false;
    }

    function closeUnclaimModal() {
        document.getElementById('unclaimModal').style.display = 'none';
        currentUnclaimForm = null;
    }

    document.getElementById('confirmUnclaimBtn').addEventListener('click', function() {
        if (currentUnclaimForm) {
            currentUnclaimForm.submit();
        }
    });
    
    // Delete Modal Functions
    function openDeleteModal() {
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    // Close modal if clicked outside (Handles both)
    window.onclick = function(event) {
        const unclaimModal = document.getElementById('unclaimModal');
        const deleteModal = document.getElementById('deleteModal');
        const mapModal = document.getElementById('mapModal');
        if (event.target == unclaimModal) {
            closeUnclaimModal();
        }
        if (deleteModal && event.target == deleteModal) {
            closeDeleteModal();
        }
        if (event.target == mapModal) {
            closeMapModal();
        }
    }

    // Map Logic
    let map = null;
    let marker = null;
    let selectedLat = 18.5204; // Default Pune
    let selectedLng = 73.8567;

    function openMapModal() {
        document.getElementById('mapModal').style.display = 'flex';
        
        // Initialize map if not already done
        if (!map) {
            map = L.map('location-map').setView([selectedLat, selectedLng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            
            // Check if form has existing values
            const formLat = parseFloat(document.querySelector('input[name="latitude"]').value);
            const formLng = parseFloat(document.querySelector('input[name="longitude"]').value);
            
            if (!isNaN(formLat) && !isNaN(formLng)) {
                selectedLat = formLat;
                selectedLng = formLng;
            }
            
            marker = L.marker([selectedLat, selectedLng], {draggable: true}).addTo(map);
            map.setView([selectedLat, selectedLng], 13);

            marker.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                selectedLat = pos.lat;
                selectedLng = pos.lng;
            });

            // Click map to move marker
            map.on('click', function(e) {
                marker.setLatLng(e.latlng);
                selectedLat = e.latlng.lat;
                selectedLng = e.latlng.lng;
            });
        } else {
             // Refresh state in case form changed externally or re-opened
            const formLat = parseFloat(document.querySelector('input[name="latitude"]').value);
            const formLng = parseFloat(document.querySelector('input[name="longitude"]').value);
             if (!isNaN(formLat) && !isNaN(formLng)) {
                selectedLat = formLat;
                selectedLng = formLng;
                marker.setLatLng([selectedLat, selectedLng]);
                map.setView([selectedLat, selectedLng], 13);
            }
            setTimeout(() => { map.invalidateSize(); }, 100);
        }
    }

    function closeMapModal() {
        document.getElementById('mapModal').style.display = 'none';
    }

    function confirmLocation() {
        document.querySelector('input[name="latitude"]').value = selectedLat.toFixed(6);
        document.querySelector('input[name="longitude"]').value = selectedLng.toFixed(6);
        document.getElementById('loc-status').textContent = "Location selected from map!";
        closeMapModal();
    }
</script>
{% endblock %}
