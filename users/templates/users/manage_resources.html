{% extends 'base.html' %}
{% block title %}Manage Resources{% endblock %}

{% block content %}
<div class="header-section" style="max-width: 1000px; margin: 2rem auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1 style="color: var(--text-color);">My Activity</h1>
        <a href="{% url 'dashboard' %}" class="btn" style="background: var(--text-color);">Back to Dashboard</a>
    </div>

    <!-- Tabs -->
    <div style="margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: center;">
        <button class="tab-btn active" onclick="openTab(event, 'my-posts')">My Posts</button>
        <button class="tab-btn" onclick="openTab(event, 'my-claims')">My Claims & Requests</button>
    </div>

    <!-- My Posts Tab -->
    <div id="my-posts" class="tab-content" style="display: block;">
        {% if resources %}
            <div class="card">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: left; background: var(--bg-color); color: var(--text-color);">
                                <th style="padding: 1rem;">Title</th>
                                <th style="padding: 1rem;">Donor</th>
                                <th style="padding: 1rem;">Status</th>
                                <th style="padding: 1rem;">Urgency</th>
                                <th style="padding: 1rem;">Created</th>
                                <th style="padding: 1rem;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in resources %}
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 1rem;">
                                    <a href="{% url 'resource_detail' r.id %}" style="font-weight: 500; color: var(--primary-color);">{{ r.title }}</a>
                                </td>
                                <td style="padding: 1rem;">{{ r.donor.username }}</td>
                                <td style="padding: 1rem;">
                                    {% if r.is_active %}
                                        <span style="color: var(--status-green);">Active</span>
                                    {% else %}
                                        <span style="color: var(--text-muted);">Claimed</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 1rem; white-space: nowrap;">
                                    <span class="badge badge-{{ r.urgency }}">{{ r.get_urgency_display }}</span>
                                </td>
                                <td style="padding: 1rem;">{{ r.created_at|date:"M d" }}</td>
                                <td style="padding: 1rem;">
                                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                        <a href="{% url 'update_resource' r.id %}" class="btn" style="background: #3B82F6; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; text-decoration: none;">Edit</a>
                                        <button type="button" class="btn" style="background: #EF4444; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem;" 
                                                onclick="openDeleteModal('{% url 'delete_resource' r.id %}', '{{ r.title|escapejs }}')">Delete</button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <p>You haven't posted any resources yet.</p>
                <a href="{% url 'create_resource' %}" class="btn btn-primary" style="margin-top: 1rem;">Post a Resource</a>
            </div>
        {% endif %}
    </div>

    <!-- My Claims Tab -->
    <div id="my-claims" class="tab-content" style="display: none;">
        {% if claims %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                {% for claim in claims %}
                <div class="card" style="position: relative; border-left: 5px solid {% if claim.is_verified %}var(--success){% else %}#F59E0B{% endif %}; height: 100%; display: flex; flex-direction: column;">
                   <div style="padding: 1rem; flex: 1; display: flex; flex-direction: column; justify-content: center;">
                        <h3 style="margin: 0 0 0.35rem 0; font-size: 1.1rem; font-weight: 600; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            <a href="{% url 'resource_detail' claim.resource.id %}" style="text-decoration: none; color: inherit;">
                                {{ claim.resource.title }}
                            </a>
                        </h3>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.75rem;">
                            Donor: @{{ claim.resource.donor.username }}
                        </p>
                        
                        <div style="margin-top: auto; display: flex; justify-content: center; align-items: center; white-space: nowrap; gap: 0.75rem;">
                            <span class="badge" style="background: {% if claim.is_verified %}var(--success){% else %}#F59E0B{% endif %}; color: white; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500;">
                                {% if claim.is_verified %}Verified âœ“{% else %}Pending Pickup{% endif %}
                            </span>
                            
                            {% if not claim.is_verified %}
                            <button onclick="showQRCode('{{ claim.verification_token }}', '{{ claim.resource.title|escapejs }}')" class="btn btn-outline" style="font-size: 0.85rem; padding: 0.35rem 0.75rem; white-space: nowrap; border-radius: 6px;">
                                ðŸ“± Show QR
                            </button>
                            {% endif %}
                        </div>
                   </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <p>You haven't claimed any items yet.</p>
                <a href="{% url 'home' %}" class="btn btn-primary" style="margin-top: 1rem;">Browse Donations</a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Custom Delete Modal -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-color); padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
        <h3 style="margin-bottom: 1rem; color: var(--danger);">Delete Resource</h3>
        <p style="margin-bottom: 1.5rem; color: var(--text-color);">Are you sure you want to delete <strong id="deleteTargetName">this item</strong>? This action cannot be undone.</p>
        
        <form id="deleteForm" method="post" action="">
            {% csrf_token %}
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button type="button" class="btn" style="background: #e0e0e0; border: none; color: #333;" onclick="closeDeleteModal()">Cancel</button>
                <button type="submit" class="btn" style="background: var(--danger); color: white; border: none;">Yes, Delete it</button>
            </div>
        </form>
    </div>
</div>

<!-- QR Modal -->
<div id="qrModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 12px; text-align: center; max-width: 90%; width: 350px;">
        <h3 id="qrTitle" style="margin-bottom: 1rem; color: #333;">Scan to Verify</h3>
        <div id="qrcode" style="display: flex; justify-content: center; margin: 1.5rem 0;"></div>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">Show this to the donor when you pick up the item.</p>
        <button class="btn btn-primary" onclick="document.getElementById('qrModal').style.display='none'">Close</button>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    function showQRCode(token, title) {
        document.getElementById('qrTitle').textContent = "Pickup: " + title;
        document.getElementById('qrcode').innerHTML = ""; // Clear previous
        
        // Generate URL
        const verifyUrl = window.location.origin + "/resources/verify/" + token + "/";
        
        new QRCode(document.getElementById("qrcode"), {
            text: verifyUrl,
            width: 200,
            height: 200
        });
        
        document.getElementById('qrModal').style.display = 'flex';
    }

    // Delete Modal Scripts
    function openDeleteModal(actionUrl, itemName) {
        document.getElementById('deleteForm').action = actionUrl;
        document.getElementById('deleteTargetName').textContent = itemName;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == document.getElementById('deleteModal') || event.target == document.getElementById('qrModal')) {
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('qrModal').style.display = 'none';
        }
    }
</script>

<style>
    .tab-btn {
        background: none;
        border: none;
        padding: 1rem 1.5rem;
        cursor: pointer;
        font-size: 1rem;
        color: var(--text-muted);
        border-bottom: 2px solid transparent;
        font-weight: 500;
        transition: all 0.2s;
    }
    .tab-btn.active {
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
    }
    .tab-btn:hover:not(.active) {
        color: var(--text-color);
    }
</style>
{% endblock %}
