{% extends 'base.html' %}

{% block extra_head %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        #map-view { height: 600px; width: 100%; border-radius: 12px; z-index: 1; margin-bottom: 2rem; border: 1px solid var(--border-color); }
        .view-toggle-btn { padding: 0.6rem 1rem; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); cursor: pointer; transition: all 0.2s; }
        .view-toggle-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .view-toggle-btn:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; border-right: none; }
        .view-toggle-btn:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-left: none; }
    </style>
{% endblock %}

{% block content %}
<div class="header-section" style="margin-bottom: 2rem; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem;">
    <div>
        <h1>Nearby Resources</h1>
        <p style="color: var(--text-muted);">Showing available items within 50km of your location.</p>
    </div>
    
    <div style="display: flex;">
        <button id="listViewBtn" class="view-toggle-btn active" onclick="switchView('list')">List View</button>
        <button id="mapViewBtn" class="view-toggle-btn" onclick="switchView('map')">Map View</button>
    </div>
    
    <form method="get" action="{% url 'home' %}" 
          hx-get="{% url 'home' %}" 
          hx-target="#resource-grid" 
          hx-select="#resource-grid" 
          hx-swap="outerHTML"
          hx-push-url="true" 
          hx-trigger="submit, keyup changed delay:500ms from:#searchInput, change from:#categorySelect"
          style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        
        <div style="position: relative;">
            <input id="searchInput" type="text" name="search" placeholder="Search items..." value="{{ request.GET.search }}" 
                   style="padding: 0.6rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); width: 200px;">
        </div>
        
        <select id="categorySelect" name="category" 
                style="padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color);">
            <option value="">All Categories</option>
            <option value="food" {% if request.GET.category == 'food' %}selected{% endif %}>Food</option>
            <option value="clothing" {% if request.GET.category == 'clothing' %}selected{% endif %}>Clothing</option>
            <option value="furniture" {% if request.GET.category == 'furniture' %}selected{% endif %}>Furniture</option>
            <option value="books" {% if request.GET.category == 'books' %}selected{% endif %}>Books</option>
            <option value="supplies" {% if request.GET.category == 'supplies' %}selected{% endif %}>Supplies</option>
            <option value="other" {% if request.GET.category == 'other' %}selected{% endif %}>Other</option>
        </select>
        
        <button type="submit" class="btn btn-primary" style="padding: 0.6rem 1.2rem;">Search</button>
        
        {% if request.GET.search or request.GET.category %}
            <a href="{% url 'home' %}" class="btn" style="padding: 0.6rem 1rem; border: 1px solid var(--border-color); color: var(--text-color); display: flex; align-items: center;" 
               hx-boost="true">Clear</a>
        {% endif %}
    </form>
</div>



<div id="map-view" style="display: none;"></div>

<div id="resource-grid" class="resource-container">
    {% if categorized_resources and not request.GET.search and not request.GET.category %}
        <!-- Categorized Sections View -->
        {% for category_group in categorized_resources %}
            <div class="category-section" style="margin-bottom: 2.5rem;">
                <h2 style="font-size: 1.4rem; color: var(--text-color); margin-bottom: 1rem; border-left: 5px solid var(--primary-color); padding-left: 0.8rem; text-transform: capitalize;">
                    {{ category_group.name }}
                </h2>
                <div class="resource-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1rem;">
                    {% for res in category_group.items %}
                        {% include "resources/resource_card.html" with res=res %}
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <!-- Search/Filter Flat Grid View -->
        <div class="resource-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1rem;">
            {% for res in resources %}
                {% include "resources/resource_card.html" with res=res %}
            {% empty %}
                <p>No resources found matching your criteria.</p>
            {% endfor %}
        </div>
    {% endif %}
</div>
</div>

<!-- Custom Claim Modal -->
<div id="claimModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-color); padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
        <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Claim Resource</h3>
        <p style="margin-bottom: 1rem; color: var(--text-color);">How many units would you like to claim?</p>
        
        <div style="margin-bottom: 1.5rem; display: flex; justify-content: center; align-items: center; gap: 1rem;">
            <button type="button" class="btn" style="width: 30px; height: 30px; padding: 0; background: #ddd; color: #333; border: none; border-radius: 50%; font-weight: bold; font-size: 1.2rem;" onclick="adjustQty(-1)">-</button>
            <input type="number" id="claimQtyInput" value="1" min="1" max="999" style="width: 60px; text-align: center; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1.1rem; -moz-appearance: textfield;">
            <button type="button" class="btn" style="width: 30px; height: 30px; padding: 0; background: #ddd; color: #333; border: none; border-radius: 50%; font-weight: bold; font-size: 1.2rem;" onclick="adjustQty(1)">+</button>
        </div>
        <p id="availQtyText" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1.5rem;">Available: <span>Loading...</span></p>

        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button class="btn" style="background: #e0e0e0; border: none; color: #333;" onclick="closeModal()">Cancel</button>
            <button id="confirmClaimBtn" class="btn btn-primary">Yes, Claim it!</button>
        </div>
    </div>
</div>

<script>
    let currentForm = null;
    let maxAvailable = 1;

    function openClaimModal(event, form, availableQty) {
        event.preventDefault();
        event.stopPropagation();
        currentForm = form;
        maxAvailable = availableQty || 999;
        
        // Reset input
        const input = document.getElementById('claimQtyInput');
        input.value = 1;
        input.max = maxAvailable;
        document.querySelector('#availQtyText span').textContent = maxAvailable;
        
        document.getElementById('claimModal').style.display = 'flex';
        return false;
    }

    function adjustQty(delta) {
        const input = document.getElementById('claimQtyInput');
        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 1) val = 1;
        if (val > maxAvailable) val = maxAvailable;
        input.value = val;
    }

    function closeModal() {
        document.getElementById('claimModal').style.display = 'none';
        currentForm = null;
    }

    document.getElementById('confirmClaimBtn').addEventListener('click', function() {
        if (currentForm) {
            // Inject quantity input into the form before submitting
            const qty = document.getElementById('claimQtyInput').value;
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'quantity';
            hiddenInput.value = qty;
            currentForm.appendChild(hiddenInput);
            
            currentForm.submit();
        }
    });

    // Close modal if clicked outside
    window.onclick = function(event) {
        const modal = document.getElementById('claimModal');
        if (event.target == modal) {
            closeModal();
        }
    }
    </script>
    
    {{ map_resources|json_script:"map-data" }}
    
    <script>
        let map = null;
        let mapInitialized = false;

        function switchView(view) {
            const listBtn = document.getElementById('listViewBtn');
            const mapBtn = document.getElementById('mapViewBtn');
            const listView = document.getElementById('resource-grid');
            const mapView = document.getElementById('map-view');

            if (view === 'list') {
                listBtn.classList.add('active');
                mapBtn.classList.remove('active');
                listView.style.display = 'block';
                mapView.style.display = 'none';
            } else {
                listBtn.classList.remove('active');
                mapBtn.classList.add('active');
                listView.style.display = 'none';
                mapView.style.display = 'block';
                
                if (!mapInitialized) {
                    initMap();
                } else {
                    setTimeout(() => { map.invalidateSize(); }, 100);
                }
            }
        }

        function initMap() {
            // Default to Pune or User's Location passed from backend if available
            // For now, let's use the first resource's location or a default center
            const resources = JSON.parse(document.getElementById('map-data').textContent);
            
            let center = [18.5204, 73.8567]; // Default Pune
            if (resources.length > 0) {
                // Use first resource as center simply
                center = [resources[0].latitude, resources[0].longitude];
            }
            
            // Allow user location override if we had it in template context, but for now simple center
            
            map = L.map('map-view').setView(center, 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            resources.forEach(res => {
                const marker = L.marker([res.latitude, res.longitude]).addTo(map);
                
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 5px 0; font-size: 1rem;">${res.title}</h3>
                        <p style="margin: 0 0 5px 0; font-size: 0.8rem; color: #666;">${res.category} â€¢ ${res.available_quantity} ${res.unit}</p>
                        <a href="${res.url}" class="btn btn-primary" style="display: inline-block; padding: 3px 8px; font-size: 0.8rem; text-decoration: none; color: white; background: var(--primary-color, #007bff); border-radius: 4px;">View Details</a>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
            });
            
            mapInitialized = true;
        }
    </script>
{% endblock %}
