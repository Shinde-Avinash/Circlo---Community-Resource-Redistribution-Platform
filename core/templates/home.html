{% extends 'base.html' %}

{% block content %}
<div class="header-section" style="margin-bottom: 2rem; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem;">
    <div>
        <h1>Nearby Resources</h1>
        <p style="color: var(--text-muted);">Showing available items within 50km of your location.</p>
    </div>
    
    <form method="get" action="{% url 'home' %}" 
          hx-get="{% url 'home' %}" 
          hx-target="#resource-grid" 
          hx-select="#resource-grid" 
          hx-swap="outerHTML"
          hx-push-url="true" 
          hx-trigger="submit, keyup changed delay:500ms from:#searchInput, change from:#categorySelect"
          style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        
        <div style="position: relative;">
            <input id="searchInput" type="text" name="search" placeholder="Search items..." value="{{ request.GET.search }}" 
                   style="padding: 0.6rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); width: 200px;">
        </div>
        
        <select id="categorySelect" name="category" 
                style="padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color);">
            <option value="">All Categories</option>
            <option value="food" {% if request.GET.category == 'food' %}selected{% endif %}>Food</option>
            <option value="clothing" {% if request.GET.category == 'clothing' %}selected{% endif %}>Clothing</option>
            <option value="furniture" {% if request.GET.category == 'furniture' %}selected{% endif %}>Furniture</option>
            <option value="books" {% if request.GET.category == 'books' %}selected{% endif %}>Books</option>
            <option value="supplies" {% if request.GET.category == 'supplies' %}selected{% endif %}>Supplies</option>
            <option value="other" {% if request.GET.category == 'other' %}selected{% endif %}>Other</option>
        </select>
        
        <button type="submit" class="btn btn-primary" style="padding: 0.6rem 1.2rem;">Search</button>
        
        {% if request.GET.search or request.GET.category %}
            <a href="{% url 'home' %}" class="btn" style="padding: 0.6rem 1rem; border: 1px solid var(--border-color); color: var(--text-color); display: flex; align-items: center;" 
               hx-boost="true">Clear</a>
        {% endif %}
    </form>
</div>

<div id="resource-grid" class="resource-container">
    {% if categorized_resources and not request.GET.search and not request.GET.category %}
        <!-- Categorized Sections View -->
        {% for category_group in categorized_resources %}
            <div class="category-section" style="margin-bottom: 2.5rem;">
                <h2 style="font-size: 1.4rem; color: var(--text-color); margin-bottom: 1rem; border-left: 5px solid var(--primary-color); padding-left: 0.8rem; text-transform: capitalize;">
                    {{ category_group.name }}
                </h2>
                <div class="resource-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1rem;">
                    {% for res in category_group.items %}
                        {% include "resources/resource_card.html" with res=res %}
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <!-- Search/Filter Flat Grid View -->
        <div class="resource-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1rem;">
            {% for res in resources %}
                {% include "resources/resource_card.html" with res=res %}
            {% empty %}
                <p>No resources found matching your criteria.</p>
            {% endfor %}
        </div>
    {% endif %}
</div>
</div>

<!-- Custom Claim Modal -->
<div id="claimModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-color); padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
        <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Claim Resource</h3>
        <p style="margin-bottom: 1rem; color: var(--text-color);">How many units would you like to claim?</p>
        
        <div style="margin-bottom: 1.5rem; display: flex; justify-content: center; align-items: center; gap: 1rem;">
            <button type="button" class="btn" style="width: 30px; height: 30px; padding: 0; background: #ddd; color: #333; border: none; border-radius: 50%; font-weight: bold; font-size: 1.2rem;" onclick="adjustQty(-1)">-</button>
            <input type="number" id="claimQtyInput" value="1" min="1" max="999" style="width: 60px; text-align: center; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1.1rem; -moz-appearance: textfield;">
            <button type="button" class="btn" style="width: 30px; height: 30px; padding: 0; background: #ddd; color: #333; border: none; border-radius: 50%; font-weight: bold; font-size: 1.2rem;" onclick="adjustQty(1)">+</button>
        </div>
        <p id="availQtyText" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1.5rem;">Available: <span>Loading...</span></p>

        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button class="btn" style="background: #e0e0e0; border: none; color: #333;" onclick="closeModal()">Cancel</button>
            <button id="confirmClaimBtn" class="btn btn-primary">Yes, Claim it!</button>
        </div>
    </div>
</div>

<script>
    let currentForm = null;
    let maxAvailable = 1;

    function openClaimModal(event, form, availableQty) {
        event.preventDefault();
        event.stopPropagation();
        currentForm = form;
        maxAvailable = availableQty || 999;
        
        // Reset input
        const input = document.getElementById('claimQtyInput');
        input.value = 1;
        input.max = maxAvailable;
        document.querySelector('#availQtyText span').textContent = maxAvailable;
        
        document.getElementById('claimModal').style.display = 'flex';
        return false;
    }

    function adjustQty(delta) {
        const input = document.getElementById('claimQtyInput');
        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 1) val = 1;
        if (val > maxAvailable) val = maxAvailable;
        input.value = val;
    }

    function closeModal() {
        document.getElementById('claimModal').style.display = 'none';
        currentForm = null;
    }

    document.getElementById('confirmClaimBtn').addEventListener('click', function() {
        if (currentForm) {
            // Inject quantity input into the form before submitting
            const qty = document.getElementById('claimQtyInput').value;
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'quantity';
            hiddenInput.value = qty;
            currentForm.appendChild(hiddenInput);
            
            currentForm.submit();
        }
    });

    // Close modal if clicked outside
    window.onclick = function(event) {
        const modal = document.getElementById('claimModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}
