{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CRRP{% endblock %} | Community Resource Platform</title>
    <link rel="icon" type="image/png" href="/media/public/Circlo.png">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v=2">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    {% block extra_head %}{% endblock %}
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Circlo">
</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}' style="display: flex; flex-direction: column; min-height: 100vh; margin: 0;">

<nav class="navbar">
    <div class="navbar-container">
        <!-- 1. Brand -->
        <a href="/" class="navbar-brand">
            <span style="color: var(--primary-color);">Circlo</span>
        </a>

        <!-- 2. Navigation Links (Center) -->
        <div class="navbar-center">
            <a href="/" class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}">Feed</a>
            <a href="{% url 'leaderboard' %}" class="nav-link {% if request.resolver_match.url_name == 'leaderboard' %}active{% endif %}">Leaderboard</a>
            {% if user.is_authenticated %}
                <a href="{% url 'post_resource' %}" class="nav-link {% if request.resolver_match.url_name == 'post_resource' %}active{% endif %}">Post</a>
                <a href="{% url 'manage_resources' %}" class="nav-link {% if request.resolver_match.url_name == 'manage_resources' %}active{% endif %}">Activity</a>
                <a href="{% url 'inbox' %}" class="nav-link {% if request.resolver_match.url_name == 'inbox' %}active{% endif %}">Inbox</a>
            {% endif %}
        </div>

        <!-- 3. User Actions (Right) -->
        <div class="navbar-right">
            {% if user.is_authenticated %}
                {% if user.role == 'moderator' or user.is_superuser %}
                    <a href="{% url 'dashboard' %}" class="nav-link" style="color: #EF4444; font-weight: 600;">Admin</a>
                {% endif %}

                <a href="{% url 'notification_list' %}" class="icon-btn" title="Notifications">
                    üîî
                    <span id="notification-badge" class="badge-dot"></span>
                </a>

                <div class="user-menu">
                    <a href="{% url 'profile' %}" class="profile-link">
                        <div class="avatar-small">
                            {% if user.profile_image %}
                                <img src="{{ user.profile_image.url }}" alt="Profile">
                            {% else %}
                                <span>{{ user.username|make_list|first|upper }}</span>
                            {% endif %}
                        </div>
                        <span class="username">{{ user.username }}</span>
                    </a>
                    <form action="{% url 'logout' %}" method="post" style="display: flex;">
                        {% csrf_token %}
                        <button type="submit" class="icon-btn logout-btn" title="Logout">‚Ü©Ô∏è</button>
                    </form>
                </div>
            {% else %}
                <a href="{% url 'login' %}" class="nav-link">Login</a>
                <a href="{% url 'register' %}" class="btn btn-primary btn-sm">Join Now</a>
            {% endif %}
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">üåô</button>
        </div>
    </div>
</nav>

<div class="container" style="flex: 1; width: 100%; max-width: 1200px; margin: 0 auto; padding: 2rem 1rem;">
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    {% block content %}
    {% endblock %}
</div>

<!-- Modern Footer -->
<footer style="background: var(--bg-card); border-top: 1px solid var(--border-color); padding: 4rem 1rem 2rem 1rem; margin-top: auto;">
    <div style="max-width: 1200px; margin: 0 auto;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 3rem; margin-bottom: 3rem;">
            <!-- Brand Column -->
            <div>
                <h3 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1.5rem;">Circlo</h3>
                <p style="color: var(--text-muted); line-height: 1.6;">
                    Connect, share, and redistribute resources within your community. Together we can reduce waste and help each other.
                </p>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <a href="#" style="text-decoration: none; font-size: 1.2rem;">üê¶</a>
                    <a href="#" style="text-decoration: none; font-size: 1.2rem;">üìò</a>
                    <a href="#" style="text-decoration: none; font-size: 1.2rem;">üì∏</a>
                </div>
            </div>

            <!-- Links Column -->
            <div>
                <h4 style="color: var(--text-color); margin-bottom: 1rem;">Community</h4>
                <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.8rem;">
                    <li><a href="{% url 'home' %}" style="text-decoration: none; color: var(--text-muted); transition: color 0.2s;">Recent Posts</a></li>
                    <li><a href="{% url 'leaderboard' %}" style="text-decoration: none; color: var(--text-muted); transition: color 0.2s;">Top Donors</a></li>
                    <li><a href="#" style="text-decoration: none; color: var(--text-muted); transition: color 0.2s;">Guidelines</a></li>
                    <li><a href="#" style="text-decoration: none; color: var(--text-muted); transition: color 0.2s;">Success Stories</a></li>
                </ul>
            </div>

            <!-- Contact/Connect Column -->
            <div>
                <h4 style="color: var(--text-color); margin-bottom: 1rem;">Connect</h4>
                <p style="color: var(--text-muted); margin-bottom: 0.5rem;">support@circlo.local</p>
                <p style="color: var(--text-muted); margin-bottom: 0.5rem;">Pune, Maharashtra</p>
                {% if not user.is_authenticated %}
                    <a href="{% url 'register' %}" class="btn btn-primary" style="margin-top: 1rem; display: inline-block;">Join the Movement</a>
                {% endif %}
            </div>
        </div>
        
        <!-- Copyright -->
        <div style="border-top: 1px solid var(--border-color); padding-top: 2rem; text-align: center; color: var(--text-muted); font-size: 0.9rem;">
            <p>&copy; {% now "Y" %} Circlo Platform. Built with ‚ù§Ô∏è for the community.</p>
        </div>
    </div>
</footer>

<script>
    // Theme Toggling Logic
    function toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }

    // Initialize Theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);

    // Notification Polling
    function updateNotifications() {
        const badge = document.getElementById('notification-badge');
        if (!badge) return;

        fetch('{% url "notification_count" %}')
        .then(response => {
            if (response.ok) return response.json();
            throw new Error('Network response was not ok');
        })
        .then(data => {
            if (data.count > 0) {
                badge.style.display = 'flex';
                badge.innerText = data.count > 9 ? '9+' : data.count;
            } else {
                badge.style.display = 'none';
            }
        })
        .catch(error => console.log('Notification poll error', error));
    }

    // Poll every 15 seconds if user is logged in
    if (document.getElementById('notification-badge')) {
        updateNotifications(); 
        setInterval(updateNotifications, 15000);
    }
</script>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js').then(function(registration) {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
</script>
</body>
</html>
